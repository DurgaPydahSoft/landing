# Verify Token Endpoint Documentation

## Endpoint Details

**URL:** `POST http://localhost:8000/auth/verify-token`

**Purpose:** Verify encrypted SSO tokens sent from the CRM to the student portal.

## Request Format

```http
POST /auth/verify-token
Content-Type: application/json
Origin: http://localhost:3000

{
  "encryptedToken": "<encrypted-token-from-url-query-parameter>"
}
```

## Success Response (200)

```json
{
  "success": true,
  "valid": true,
  "data": {
    "userId": 43,
    "portalId": "student-portal",
    "role": "super_admin",
    "expiresAt": "2025-01-27T12:00:00.000Z"
  }
}
```

## Error Responses

### Missing Token (400)
```json
{
  "success": false,
  "message": "Authentication token is required"
}
```

### Invalid/Expired Token (401)
```json
{
  "success": false,
  "valid": false,
  "message": "Invalid or expired token"
}
```

### Invalid Token Type (400)
```json
{
  "success": false,
  "message": "Invalid token type"
}
```

### Decryption Failed (400)
```json
{
  "success": false,
  "valid": false,
  "message": "Failed to decrypt token"
}
```

## Testing

### Test Endpoint Availability
```bash
GET http://localhost:8000/auth/verify-token/test
```

### Test with cURL
```bash
curl -X POST http://localhost:8000/auth/verify-token \
  -H "Content-Type: application/json" \
  -H "Origin: http://localhost:3000" \
  -d '{"encryptedToken": "your-encrypted-token-here"}'
```

## CORS Configuration

The endpoint allows requests from:
- `http://localhost:3000` (Student Portal)
- `http://localhost:3001` (Development Portal)
- `http://localhost:5173` (CRM Frontend)

## Notes

1. The endpoint is **public** (no authentication required) but requires a valid encrypted token.
2. The token must be generated by the CRM's `/auth/generate-token` endpoint.
3. The `userId` in the response corresponds to:
   - For RBAC users: `rbac_users.id`
   - For Students: `student_credentials.student_id` (which maps to `students.id`)
4. The `role` field contains the user's role (e.g., `super_admin`, `student`, etc.)

## Troubleshooting

### 404 Error
- Check that the CRM backend is running on port 8000
- Verify the URL is exactly: `http://localhost:8000/auth/verify-token`
- Check server logs for `[404] Route not found` messages

### CORS Error
- Ensure the student portal origin is in the CORS allowed list
- Check that preflight OPTIONS requests are handled

### Empty Response
- Check server logs for `[VerifyToken]` messages
- Verify the request body contains `encryptedToken`
- Check for decryption/verification errors in logs
